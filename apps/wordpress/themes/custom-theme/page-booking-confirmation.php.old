<?php
/*
Template Name: Booking Confirmation
Description: Booking confirmation and payment page (expects start, end, teacher query params).
*/

get_header();

// Extract and lightly validate query params
$start = isset($_GET['start']) ? sanitize_text_field(wp_unslash($_GET['start'])) : '';
$end = isset($_GET['end']) ? sanitize_text_field(wp_unslash($_GET['end'])) : '';
$teacher = isset($_GET['teacher']) ? sanitize_text_field(wp_unslash($_GET['teacher'])) : '';
// Normalize teacher id to digits only (handles stray chars like trailing braces)
$teacher = preg_replace('/\D+/', '', (string) $teacher);

// Basic ISO validation (very lenient); in a future pass, tighten this or parse to DateTime
$is_iso_like = function ($s) {
    // Accept: YYYY-MM-DDTHH:MMZ, optional :SS, optional fractional seconds (e.g., .000)
    return is_string($s)
        && preg_match('/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(?::\d{2}(?:\.\d{1,6})?)?Z$/', $s);
};

$errors = [];
if (!$is_iso_like($start)) {
    $errors[] = 'Invalid or missing start time.';
}
if (!$is_iso_like($end)) {
    $errors[] = 'Invalid or missing end time.';
}
if ($teacher === '' || !ctype_digit($teacher)) {
    $errors[] = 'Invalid or missing teacher.';
}

?>
<main id="primary" class="site-main" style="max-width:860px;margin:0 auto;padding:24px;">
    <h1 style="margin:0 0 16px 0;">Confirm Your Booking</h1>

    <?php if (!empty($errors)): ?>
        <div class="notice notice-error"
            style="background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:12px 16px;border-radius:10px;">
            <strong>We couldn't load your booking details:</strong>
            <ul style="margin:8px 0 0 18px;">
                <?php foreach ($errors as $e): ?>
                    <li><?php echo esc_html($e); ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
        <p style="margin-top:12px;">
            <a href="<?php echo esc_url(home_url('/booking')); ?>" class="button">Back to calendar</a>
        </p>
    <?php else: ?>
        <?php
        // If not logged in, prompt login and stop here
        if (!function_exists('thrive_is_logged_in') || !thrive_is_logged_in()):
            // Build redirect back to this page with original query
            global $wp;
            $path = home_url(add_query_arg(array(), $wp->request));
            $query = isset($_SERVER['QUERY_STRING']) && $_SERVER['QUERY_STRING'] !== '' ? ('?' . sanitize_text_field(wp_unslash($_SERVER['QUERY_STRING']))) : '';
            $redirect_to = $path . $query;
            ?>
            <section style="background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:16px 18px;">
                <p style="margin:0 0 10px 0;">Please sign in to continue with your booking.</p>
                <a class="button button-primary"
                    href="<?php echo esc_url('/api/auth/google/start?redirect=' . rawurlencode($redirect_to)); ?>">Sign in with
                    Google</a>
                <a class="button" style="margin-left:8px;" href="<?php echo esc_url(home_url('/booking')); ?>">Back to
                    calendar</a>
            </section>
        <?php else: ?>
            <section style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px 18px;">
                <p style="margin:0 0 8px 0;color:#374151;">Please review your session details and continue.</p>
                <div style="display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center;">
                    <div style="color:#6b7280;font-weight:600;">Start (UTC)</div>
                    <div><?php echo esc_html($start); ?></div>
                    <div style="color:#6b7280;font-weight:600;">End (UTC)</div>
                    <div><?php echo esc_html($end); ?></div>
                    <div style="color:#6b7280;font-weight:600;">Teacher</div>
                    <div>#<?php echo esc_html($teacher); ?></div>
                </div>
                <div style="margin-top:16px;">
                    <div id="thrive-payment-container" style="border:1px solid #e5e7eb;border-radius:10px;padding:16px;">
                        <div id="payment-element"><!-- Stripe Payment Element injects here --></div>
                        <div id="payment-messages" role="alert" style="margin-top:10px;color:#991b1b;display:none;"></div>
                        <div style="display:flex;gap:10px;align-items:center;margin-top:14px;">
                            <button id="thrive-pay-button" class="button button-primary">Confirm and Pay</button>
                            <a href="<?php echo esc_url(home_url('/booking')); ?>" class="button">Cancel</a>
                        </div>
                    </div>
                    <p id="thrive-payment-loader" style="margin-top:10px;color:#6b7280;">Preparing secure payment...</p>
                </div>
            </section>
        <?php endif; // end login check ?>
    <?php endif; ?>
</main>
<?php get_footer(); ?>