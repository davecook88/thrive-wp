services:
  nestjs:
    # Use monorepo root as working directory
    working_dir: /app
    volumes:
      # Mount source files for hot reload (keep consistent with main docker-compose.yml)
      - ./apps/nestjs/src:/app/apps/nestjs/src:cached
      - ./apps/nestjs/test:/app/apps/nestjs/test:cached
      - ./apps/nestjs/package.json:/app/apps/nestjs/package.json:cached
      - ./apps/nestjs/tsconfig.json:/app/apps/nestjs/tsconfig.json:cached
      - ./apps/nestjs/nest-cli.json:/app/apps/nestjs/nest-cli.json:cached
      # Mount shared package source and dist for monorepo workspace
      - ./packages/shared/src:/app/packages/shared/src:cached
      - ./packages/shared/dist:/app/packages/shared/dist:cached
      - ./packages/shared/package.json:/app/packages/shared/package.json:cached
      - ./packages/shared/tsconfig.json:/app/packages/shared/tsconfig.json:cached
      # Mount workspace config files
      - ./package.json:/app/package.json:cached
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:cached
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml:cached
    command: sh -c "ln -sfn /app/node_modules /app/packages/shared/node_modules && cd apps/nestjs && exec pnpm exec nest start --watch"
    environment:
      NODE_ENV: development
      NODE_PATH: /app/node_modules
    ports:
      - '3000:3000'
