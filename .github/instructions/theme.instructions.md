---
applyTo: 'wordpress/themes/custom-theme'
---
# WordPress Block Theme Development Instructions

## Overview
This document contains critical instructions for developing and maintaining the custom WordPress block theme in this project. These instructions are based on real-world troubleshooting and development experience.

## Block Theme Architecture

### Template Hierarchy
- **`templates/index.html`** - Default template for all content types (posts, archives)
- **`templates/page.html`** - Specific template for pages (overrides index.html for pages)
- **`templates/single.html`** - Template for individual posts
- **`templates/archive.html`** - Template for archive pages

### Key Template Patterns
```html
<!-- Standard page template structure -->
<!-- wp:template-part {"slug":"header"} /-->

<!-- wp:group {"tagName":"main","layout":{"type":"constrained"}} -->
<main class="wp-block-group">
    <!-- wp:post-content /-->
</main>
<!-- /wp:group -->

<!-- wp:template-part {"slug":"footer"} /-->
```

**CRITICAL**: Use `<!-- wp:post-content /-->` to display actual page/post content. Do NOT hardcode patterns in page templates unless you specifically want to override the content.

## Pattern Development Guidelines

### Pattern File Structure
- Patterns are stored in `wordpress/themes/custom-theme/patterns/`
- Each pattern must have proper WordPress block markup
- Patterns are referenced using `<!-- wp:pattern {"slug":"custom-theme/pattern-name"} /-->`

### Block Markup Validation Rules

#### Image Blocks
```html
<!-- CORRECT -->
<figure class="wp-block-image size-large has-custom-border">
    <img src="https://example.com/image.jpg" alt="Description" style="border-radius:20px"/>
</figure>

<!-- WRONG - Never use div placeholders -->
<figure class="wp-block-image size-large has-custom-border">
    <div>Image placeholder</div>
</figure>
```

#### Button Blocks
```html
<!-- CORRECT - Class order matters -->
<div class="wp-block-button">
    <a class="wp-block-button__link has-background-color has-foreground-background-color has-text-color has-background wp-element-button" 
       style="border-radius:50px;padding-top:15px;padding-right:30px;padding-bottom:15px;padding-left:30px">
       Button Text
    </a>
</div>
```

**CRITICAL**: Button class order and inclusion of `has-background` class is essential for validation. WordPress expects specific class combinations.

#### Column Blocks
```html
<!-- CORRECT - Use standard gap attribute -->
<div class="wp-block-columns alignwide">
    <!-- columns content -->
</div>

<!-- WRONG - Avoid inline gap styles that can cause validation errors -->
<div class="wp-block-columns alignwide" style="gap:2rem">
```

### Heading Blocks with Background
```html
<!-- CRITICAL - Include has-background class for colored headings -->
<h1 class="wp-block-heading has-background-color has-accent-background-color has-text-color has-background" 
    style="border-radius:8px;margin-bottom:1.5rem;padding-top:10px;padding-right:20px;padding-bottom:10px;padding-left:20px;font-size:3.5rem;font-style:normal;font-weight:700;line-height:1.1">
    Heading Text
</h1>
```

## Database Content Management

### Updating Page Content
When pattern files are updated, existing page content must be manually updated in the database:

```sql
UPDATE wp_posts 
SET post_content = 'NEW_BLOCK_MARKUP_HERE'
WHERE ID = PAGE_ID;
```

**IMPORTANT**: WordPress does not automatically sync pattern changes to existing pages. Pattern updates only affect new instances.

### Finding Homepage Settings
```sql
-- Check what's set as homepage
SELECT option_name, option_value FROM wp_options 
WHERE option_name IN ('show_on_front', 'page_on_front', 'page_for_posts');
```

## Block Validation Error Resolution

### Common Validation Issues

1. **Image Block Errors**
   - Cause: `<div>` placeholders instead of `<img>` tags
   - Solution: Always use proper `<img>` elements with src attributes

2. **Button Class Mismatches**
   - Cause: Inconsistent class order or missing `has-background` class
   - Solution: Ensure exact class matching between patterns and database content

3. **Column Gap Issues**
   - Cause: Inline gap styles conflicting with block editor expectations
   - Solution: Use WordPress standard gap attributes instead of inline styles

4. **Heading Background Classes**
   - Cause: Missing `has-background` class on headings with background colors
   - Solution: Always include `has-background` class for elements with background colors

### Debugging Block Validation
1. Open WordPress editor for the problematic page
2. Check browser console for validation errors
3. Compare "Content generated by save function" vs "Content retrieved from post body"
4. Update pattern files to match expected markup
5. Update database content if necessary

## Development Workflow

### Pattern Update Process
1. **Modify pattern files** in `wordpress/themes/custom-theme/patterns/`
2. **Test patterns** by inserting them in the block editor
3. **Check for validation errors** in browser console
4. **Update existing pages** by modifying database content if needed
5. **Verify frontend display** matches editor preview

### Template Troubleshooting
If a page isn't displaying custom content:
1. Check if appropriate template exists (`page.html` for pages)
2. Verify template uses `<!-- wp:post-content /-->` not hardcoded patterns
3. Clear any WordPress caching
4. Check homepage settings in wp_options table

## File Organization

```
wordpress/themes/custom-theme/
├── templates/
│   ├── index.html          # Default template
│   ├── page.html           # Page template  
│   ├── single.html         # Post template
│   └── archive.html        # Archive template
├── patterns/
│   ├── thrive-hero.php
│   ├── statistics-section.php
│   ├── self-paced-section.php
│   ├── diego-section.php
│   └── courses-grid.php
├── parts/
│   ├── header.html
│   └── footer.html
├── theme.json              # Theme configuration
├── functions.php           # Theme functions
├── style.css              # Theme styles
└── index.php              # Fallback template
```

## Testing Checklist

### Before Deployment
- [ ] All patterns validate without errors in block editor
- [ ] Frontend matches editor preview exactly
- [ ] Browser console shows no block validation errors
- [ ] Images display properly (no broken links)
- [ ] Buttons have correct styling and classes
- [ ] Page content displays correctly (not hardcoded template patterns)
- [ ] Homepage settings are correct

### Block Editor Testing
- [ ] Insert each pattern individually - no validation errors
- [ ] Save and reload page - content persists correctly
- [ ] Switch between visual and code editor - markup remains valid
- [ ] Check console messages for any warnings or errors

## Common Pitfalls

1. **Template Override Issues**: Creating `index.html` with hardcoded patterns will override all page content
2. **Class Order Dependencies**: WordPress is strict about CSS class order in button and heading blocks
3. **Image Placeholder Problems**: Never use `<div>` placeholders in image blocks
4. **Pattern vs Content Confusion**: Pattern updates don't automatically update existing page content
5. **Missing Templates**: Pages need `page.html` template to display custom content properly

## Useful Commands

```bash
# Check database content
docker-compose exec db mysql -u wordpress -p'wordpress' wordpress -e "SELECT post_content FROM wp_posts WHERE ID = 5;"

# Apply database updates
docker-compose exec db mysql -u wordpress -p'wordpress' wordpress < wordpress/themes/custom-theme/fixed_content.sql

# Restart WordPress container
docker-compose restart wordpress

# Check WordPress logs
docker-compose logs wordpress
```

## Development Environment
- Edit files in this directory; changes are live in Docker via volume mount.
- Add new parts in `parts/` and patterns in `patterns/`.
- Update `theme.json` to register new template parts.
- No container rebuild needed for theme changes.
- This theme is deployed by mounting to `/var/www/html/wp-content/themes/custom-theme` in the WordPress container.

## Performance Considerations

- Use appropriate image sizes in patterns
- Avoid excessive inline styles
- Keep pattern complexity reasonable
- Test with caching enabled
- Validate markup regularly during development

## Future Development Notes

- Always create proper templates for different content types
- Maintain consistency between pattern files and database content
- Test thoroughly in block editor before frontend testing
- Keep this documentation updated with new learnings
- Consider automated testing for block validation in CI/CD pipeline

## Homepage Content Source (Added 2025-08-18)

The visible homepage hero ("Thrive in Spanish ...") is NOT rendered directly from the `patterns/thrive-hero.php` file at runtime. Instead, when the pattern was first inserted into the homepage, its block markup was copied into the `wp_posts.post_content` for the homepage (ID 5). Subsequent edits to `patterns/thrive-hero.php` will NOT change the live page automatically. To modify the live hero you must either:

1. Edit the page in the WordPress block editor and adjust the blocks there; or
2. Run a SQL update against `wp_posts` (ID 5) replacing the relevant block HTML.

Example (token tweak we applied):
```
UPDATE wp_posts 
SET post_content = REPLACE(post_content, 'Thrive in Spanish', 'Thrive in Spanish (Demo Tweak)')
WHERE ID = 5;
```

We performed this update to verify end‑to‑end content control; you should now see the heading "Thrive in Spanish (Demo Tweak)" on `http://localhost:8080/`.

Removed Unused Patterns:
- `patterns/hero-section.php` (not registered or referenced)
- `patterns/courses-grid.php` (not registered, not referenced in DB) — remove to avoid confusion until/if a courses grid feature is implemented.

To re-add or create new patterns, add a file under `patterns/`, then register it (mirroring the existing registration logic in `functions.php`). Remember: existing pages using older copies will not auto‑update.

## Authentication UI (Login Modal)

The theme now includes a lightweight, framework-free login modal component:

- Trigger button: `<button id="thrive-login-button">Login</button>` injected in `parts/header.html`.
- Modal markup: Added directly after header part in `parts/header.html` with `id="thrive-login-modal"`.
- Script: `js/login-modal.js` enqueued via `functions.php` (`custom_theme_scripts`). It:
    - Handles open/close (accessibility: focus trap, Escape, returning focus).
    - Redirects to NestJS Google OAuth init endpoint (`http://localhost:3000/api/auth/google`).
- Styles appended at end of `style.css` (search for `Login Modal Styles`).

Extending:
1. After implementing NestJS routes `/auth/google` & `/auth/google/callback`, successful auth should 302 back to WordPress (e.g. `/?auth=success`).
2. You may inject dynamic user state (e.g. replace button with avatar) using `wp_localize_script` or a small REST request to NestJS.

Testing (Puppeteer):
`scripts/test-login-modal.js` performs:
1. Load homepage
2. Assert login button exists
3. Open modal & assert Google button
4. Close modal

Run manually (ensure WordPress container running):
```bash
node scripts/test-login-modal.js
```

CI suggestion: Add this script to a GitHub Action job after `docker-compose up -d` and a short wait for WordPress readiness.

## Role-Based Features & User Context

### ThriveAuthContext Integration
The theme integrates with NestJS authentication through the `ThriveAuthContext` system. User information including roles is passed from NestJS via HTTP headers and parsed into a strongly-typed PHP object.

### Available Helper Functions
```php
// Authentication checks
thrive_is_logged_in(): bool
thrive_get_auth_context(): ?ThriveAuthContext

// Role-based checks
thrive_is_admin(): bool
thrive_is_teacher(): bool
thrive_user_has_role(string|ThriveRole $role): bool

// Role access
thrive_get_user_roles(): ThriveRole[]        // Enum array
thrive_get_user_role_strings(): string[]     // String array
```

### Usage Examples
```php
<?php if (thrive_is_logged_in()) : ?>
    <div class="user-welcome">
        Welcome, <?php echo esc_html(thrive_get_auth_context()->name ?? 'User'); ?>!
        
        <?php if (thrive_is_admin()) : ?>
            <a href="/admin" class="admin-link">Admin Panel</a>
        <?php endif; ?>
        
        <?php if (thrive_is_teacher()) : ?>
            <a href="/teacher" class="teacher-link">Teacher Dashboard</a>
        <?php endif; ?>
    </div>
<?php else : ?>
    <a href="/api/auth/google" class="login-link">Sign In</a>
<?php endif; ?>
```

### ThriveRole Enum
The theme uses a strongly-typed enum for role validation:
```php
enum ThriveRole: string
{
    case ADMIN = 'admin';
    case TEACHER = 'teacher';
}
```

### Security Best Practices
- Always check authentication server-side, never rely on client-side state
- Use the provided helper functions instead of direct header access
- Role checks should be performed in PHP, not JavaScript
- Sensitive content should be gated server-side using `thrive_user_has_role()`

